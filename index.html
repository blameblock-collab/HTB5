<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HUNTER THE BEGINNG 5 | ë­í‚¹</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            /* --- Dark Theme Background: #000000 (Black) --- */
            font-family: 'Inter', sans-serif;
            background-color: #000000; 
            color: #e5e7eb; /* Light Gray Text */
            min-height: 100vh;
            margin: 0;
        }
        
        /* ğŸŒŸğŸŒŸğŸŒŸ Fixed Header ë†’ì´(h-16 = 4rem = 64px)ë§Œí¼ ë³¸ë¬¸ì„ ê°•ì œì ìœ¼ë¡œ ë°€ì–´ëƒ…ë‹ˆë‹¤. ğŸŒŸğŸŒŸğŸŒŸ */
        #main-content-area {
            /* !importantë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ê³¼ì˜ ì¶©ëŒì„ ì™„ì „íˆ ë°©ì§€í•©ë‹ˆë‹¤. */
            padding-top: 6rem !important; 
        }

        /* ê¸°íƒ€ ìŠ¤íƒ€ì¼ (ìƒˆë¡œìš´ í…Œë§ˆ ì ìš©) */
        .gacha-card, .detail-container, .admin-form {
            /* ì¹´ë“œ ë°°ê²½ìƒ‰: #1A1A1A */
            border: 1px solid #333333; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); 
            background-color: #1A1A1A; 
            position: relative; 
            border-radius: 1rem;
        }
        .text-\[10px\] { font-size: 10px; }
        .circular-progress-container {
            position: relative;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .circular-progress-inner {
            position: absolute;
            width: 80%; 
            height: 80%;
            /* ì¹´ë“œ ë°°ê²½ìƒ‰ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì • */
            background-color: #1A1A1A; 
            border-radius: 50%;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #e5e7eb; 
            text-shadow: none;
        }
        
        /* ë­í¬ë³„ ìŠ¤íƒ€ì¼ ì •ì˜ (ìƒ‰ìƒ ìœ ì§€ ë˜ëŠ” ì¡°ì •) */
        .rank-S { background-color: #8b5cf6; color: #f3e8ff; border-color: #c4b5fd; } 
        .rank-A { background-color: #3b82f6; color: #eff6ff; border-color: #93c5fd; } 
        .rank-B { background-color: #10b981; color: #ecfdf5; border-color: #6ee7b7; } 
        .rank-C { background-color: #f97316; color: #fff7ed; border-color: #fdba74; } 
        .rank-D { background-color: #b45309; color: #fff7ed; border-color: #d97706; } 
        .rank-F { background-color: #4b5563; color: #f9fafb; border-color: #9ca3af; } 
        
        .ranking-tile {
            cursor: pointer;
            transition: background-color 0.1s, transform 0.1s;
            background-color: #1A1A1A; /* ì¹´ë“œ ë°°ê²½ ì‚¬ìš© */
        }
        .ranking-tile:hover {
            background-color: #2e2e2e; /* í˜¸ë²„ ì‹œ ì•½ê°„ ë°ê²Œ */
            transform: scale(1.01);
        }

        /* --- ë“±ê¸‰ë³„ í…ìŠ¤íŠ¸ ê·¸ë¼ë°ì´ì…˜ ìŠ¤íƒ€ì¼ --- */
        .grade-legendary-text {
            background-clip: text; -webkit-background-clip: text; color: transparent;
            background-image: linear-gradient(to right, #fcd34d, #fbbf24, #f59e0b); /* Gold */
            font-weight: bold;
        }
        .grade-unique-text {
            background-clip: text; -webkit-background-clip: text; color: transparent;
            background-image: linear-gradient(to right, #e879f9, #d946ef, #c026d3); /* Pink/Purple */
            font-weight: bold;
        }
        .grade-mystic-text {
            background-clip: text; -webkit-background-clip: text; color: transparent;
            background-image: linear-gradient(to right, #38bdf8, #794CFF, #BDF200); /* Purple/Lime Mix */
            font-weight: bold;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-base': '#000000',     // ê²€ì • (Main Background)
                        'card-bg': '#1A1A1A',          // ë§¤ìš° ì–´ë‘ìš´ íšŒìƒ‰ (Container/Card Background)
                        'main-purple': '#794CFF',      // ë©”ì¸ ë³´ë¼ìƒ‰ (Primary Accent)
                        'point-lime': '#BDF200',       // í¬ì¸íŠ¸ ì—°ë‘ìƒ‰ (Secondary Accent / XP / Success)
                        'main-purple-dark': '#663CE8', // ë©”ì¸ ë³´ë¼ìƒ‰ì˜ ì–´ë‘ìš´ ë²„ì „ (Hover/Border)
                        'point-lime-dark': '#99CC00',  // í¬ì¸íŠ¸ ì—°ë‘ìƒ‰ì˜ ì–´ë‘ìš´ ë²„ì „ (Gradient End)
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-primary-base">

    <!-- ê³ ì •ëœ ìƒë‹¨ ë©”ë‰´ë°” (Navbar) -->
    <header class="fixed top-0 left-0 w-full bg-primary-base shadow-xl z-50 transition-all duration-300 h-16 border-b border-gray-900">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-full"> 
                <!-- ë©”ì¸ íƒ€ì´í‹€/ë¡œê³  ë° User ID -->
                <div class="flex flex-col justify-center h-full pt-4">
                    <a href="#ranking" onclick="navigateToRanking()" class="text-2xl font-extrabold tracking-wider text-main-purple hover:text-main-purple-dark transition duration-300">
                        HUNTER THE BEGINNG 5
                    </a>
                    <!-- ì‚¬ìš©ì ID ë° ê´€ë¦¬ì ìƒíƒœ í‘œì‹œ ì˜ì—­ -->
                    <span id="user-id-display" class="text-[10px] text-gray-500 truncate mt-[-2px] block">
                        ë¡œë”© ì¤‘...
                    </span>
                </div>

                <!-- ë©”ë‰´ í•­ëª© -->
                <div class="flex items-center space-x-4">
                    <!-- ê´€ë¦¬ì ëª¨ë“œ ë²„íŠ¼ (ê´€ë¦¬ìì¼ ë•Œë§Œ í‘œì‹œ) -->
                    <a href="#admin" id="admin-link" onclick="navigateToAdmin()" class="hidden text-point-lime hover:bg-card-bg hover:text-point-lime px-3 py-2 rounded-lg text-lg font-medium transition duration-200">
                        ADMIN
                    </a>
                    
                    <a href="#ranking" onclick="navigateToRanking()" class="text-gray-300 hover:bg-card-bg hover:text-point-lime px-3 py-2 rounded-lg text-lg font-medium transition duration-200 hidden md:inline-block">
                        RANKING
                    </a>
                    <!-- ë¡œê·¸ì¸/ê´€ë¦¬ì ì¸ì¦ ë²„íŠ¼ -->
                    <button onclick="showAdminLoginModal()" class="bg-main-purple hover:opacity-80 text-white font-semibold py-2 px-4 rounded-lg ml-4 transition duration-200 shadow-lg">
                        ë¡œê·¸ì¸
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
    <main id="main-content-area" class="p-4 md:p-6 flex justify-center">

        <div class="w-full max-w-xl">
            <!-- SPA ë·° ì»¨í…Œì´ë„ˆ -->
            <div id="app-view-container">
                <!-- ë­í‚¹ ëª©ë¡ ë˜ëŠ” ìƒì„¸ ì •ë³´, ê´€ë¦¬ì í¼ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤. -->
            </div>
            
            <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° (ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ì¡°ì •) -->
            <div id="loading-indicator" class="text-center p-8 bg-card-bg text-gray-400 rounded-xl shadow-md hidden">
                <div class="animate-spin inline-block w-6 h-6 border-4 border-point-lime border-t-transparent rounded-full mr-2"></div>
                ìºë¦­í„° ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
            
            <!-- ì¹´í”¼ë¼ì´íŠ¸ ë¬¸êµ¬ (Dark Theme Adaptation) -->
            <p class="mt-8 pt-4 text-xs text-center text-gray-600 border-t border-gray-800">
                &copy; 2025 HUNTER THE BEGINNING 5
            </p>

        </div>
    </main>
    
    <!-- ğŸŒŸ ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ (Admin Login Modal) ğŸŒŸ -->
    <div id="admin-login-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[100] hidden flex items-center justify-center p-4" onclick="if(event.target.id === 'admin-login-modal') hideAdminLoginModal()">
        <div class="bg-card-bg p-6 rounded-xl shadow-2xl border border-main-purple max-w-sm w-full transition-all duration-300 transform scale-95" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-main-purple mb-4">ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
            <p class="text-sm text-gray-400 mb-4">ê´€ë¦¬ì í˜ì´ì§€ì— ì ‘ê·¼í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="password" id="admin-password-input" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 mb-4 rounded-lg bg-gray-900 text-white border border-gray-700 focus:border-point-lime focus:ring-point-lime" onkeydown="if(event.key === 'Enter') processAdminLogin()">
            <div id="admin-error-message" class="text-red-400 text-sm mb-4 hidden"></div>
            <div class="flex justify-end space-x-3">
                <button onclick="hideAdminLoginModal()" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">ì·¨ì†Œ</button>
                <button onclick="processAdminLogin()" class="bg-main-purple hover:opacity-80 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">ë¡œê·¸ì¸</button>
            </div>
        </div>
    </div>
    <!-- ğŸŒŸ ìºë¦­í„° ì €ì¥ ì„±ê³µ/ì‹¤íŒ¨ ë©”ì‹œì§€ ğŸŒŸ -->
    <div id="message-box" class="fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-white transform translate-x-full transition-transform duration-500 z-[99]">
    </div>

<!-- ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ë¥¼ í¬í•¨í•œ ì „ì²´ ì½”ë“œ ë¸”ë¡ì…ë‹ˆë‹¤. -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, onSnapshot, runTransaction, updateDoc, setDoc, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ë””ë²„ê¹…ì„ ìœ„í•´ Firestore ë¡œê·¸ ë ˆë²¨ ì„¤ì •
        setLogLevel('Debug');

        // --- 1. ì „ì—­ ë³€ìˆ˜ ë° ìƒìˆ˜ ---
        let db;
        let auth;
        let userId;
        let characters = []; 
        
        let currentView = 'ranking'; 
        let selectedCharId = null; 
        
        let currentFilterType = 'all'; 
        let currentFilterValue = null; 
        
        // ğŸŒŸ ê´€ë¦¬ì ìƒíƒœ í”Œë˜ê·¸ ë° ëª¨ì˜ ë¹„ë°€ë²ˆí˜¸
        let isAdmin = false;
        const MOCK_ADMIN_PASSWORD = "admin123"; 

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // =========================================================================
        // ğŸš¨ ìˆ˜ì •ëœ ë¶€ë¶„: í•˜ë“œì½”ë”©ëœ ì„¤ì • ëŒ€ì‹  ìº”ë²„ìŠ¤ í™˜ê²½ ë³€ìˆ˜ë¥¼ ë‹¤ì‹œ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        // =========================================================================
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const ALL_RESISTANCES = ["íƒœì–‘", "íŒŒë„", "í­í’", "ëŒ€ì§€", "ë°¤"];
        const STAT_NAMES = ["ê·¼ë ¥", "ì§€ëŠ¥", "ë¯¼ì²©", "í–‰ìš´", "ì´ì„±"];
        
        const ALLOWED_AFFILIATIONS = ["í—Œí„°ê´€ë¦¬ì²­", "ë°±ë‘ ê¸¸ë“œ", "ë¬´ì†Œì†"]; 
        const FILTERABLE_AFFILIATIONS = ALLOWED_AFFILIATIONS; 
        const FILTERABLE_RANKS = ['S', 'A', 'B', 'C', 'D', 'F']; 
        
        const RARITY_STYLES = {
            'ì¼ë°˜': { key: 'common', color: 'text-gray-400', gradeClass: 'text-gray-400' },
            'ë ˆì–´': { key: 'rare', color: 'text-blue-400', gradeClass: 'text-blue-400' },
            'ìœ ë‹ˆí¬': { key: 'unique', color: 'text-purple-400', gradeClass: 'grade-unique-text' }, 
            'ë ˆì „ë”ë¦¬': { key: 'legendary', color: 'text-yellow-400', gradeClass: 'grade-legendary-text' },
            'ë¯¸ìŠ¤í‹±': { key: 'mystic', class: 'grade-mystic-text', gradeClass: 'grade-mystic-text' } 
        };

        // --- 2. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        
        /**
         * ìˆ«ìë¥¼ ë³´ê¸° ì¢‹ê²Œ ì½¤ë§ˆë¡œ í¬ë§·í•©ë‹ˆë‹¤.
         * @param {number} num 
         * @returns {string}
         */
        const formatNumber = (num) => {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        };

        /**
         * í…ìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.
         * @param {string} title - ëª¨ë‹¬ ì œëª©
         * @param {string} message - ëª¨ë‹¬ ë©”ì‹œì§€
         */
        const showMessageModal = (title, message) => {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('hidden');
            modalContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full transform transition-all duration-300 scale-100">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">${title}</h3>
                    <p class="text-gray-600 mb-4">${message}</p>
                    <button id="close-modal-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-lg transition duration-200">
                        í™•ì¸
                    </button>
                </div>
            `;
            document.getElementById('close-modal-btn').onclick = () => {
                modalContainer.classList.add('hidden');
            };
        };

        /**
         * í—Œí„° ëŠ¥ë ¥ì¹˜ì˜ ì´í•©ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
         * @param {Object} stats - ëŠ¥ë ¥ì¹˜ ê°ì²´ (ê·¼ë ¥, ì§€ëŠ¥, ë¯¼ì²©, í–‰ìš´, ì´ì„±)
         * @returns {number} - ì´í•© ëŠ¥ë ¥ì¹˜
         */
        const calculateTotalStats = (stats) => {
            if (!stats) return 0;
            return STAT_NAMES.reduce((sum, key) => sum + (stats[key] || 0), 0);
        };

        /**
         * ì£¼ì–´ì§„ ìºë¦­í„°ì˜ ë­í¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë“±ê¸‰ í´ë˜ìŠ¤ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
         * @param {string} rarity - ìºë¦­í„°ì˜ í¬ê·€ë„ (ì¼ë°˜, ë ˆì–´, ìœ ë‹ˆí¬, ë ˆì „ë”ë¦¬, ë¯¸ìŠ¤í‹±)
         * @returns {string} - Tailwind CSS í´ë˜ìŠ¤ ë¬¸ìì—´
         */
        const getRarityClass = (rarity) => {
            const style = RARITY_STYLES[rarity];
            return style ? (style.class || style.color) : 'text-gray-500'; 
        };

        /**
         * ì£¼ì–´ì§„ ìºë¦­í„°ì˜ ì´í•© ëŠ¥ë ¥ì¹˜ì— ë”°ë¼ ë“±ê¸‰(Rank)ì„ ê²°ì •í•©ë‹ˆë‹¤.
         * (ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ ì„ì˜ì˜ ì ìˆ˜ ê¸°ì¤€ì„ ì‚¬ìš©)
         * @param {number} totalStats - ì´í•© ëŠ¥ë ¥ì¹˜
         * @returns {string} - ë­í¬ (S, A, B, C, D, F)
         */
        const determineRank = (totalStats) => {
            if (totalStats >= 5000) return 'S';
            if (totalStats >= 4000) return 'A';
            if (totalStats >= 3000) return 'B';
            if (totalStats >= 2000) return 'C';
            if (totalStats >= 1000) return 'D';
            return 'F';
        };

        // --- 3. Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ---

        /**
         * Firebase ì´ˆê¸°í™” ë° ì‚¬ìš©ì ì¸ì¦ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
         */
        const initializeFirebase = async () => {
            try {
                // firebaseConfigê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ì´ˆê¸°í™” ì „ ì˜¤ë¥˜ ë°©ì§€
                if (Object.keys(firebaseConfig).length === 0) {
                     console.error("Firebase Config is empty. Cannot initialize.");
                     document.getElementById('auth-status').textContent = `ì¸ì¦ ì˜¤ë¥˜: ì„¤ì • ì •ë³´ ì—†ìŒ`;
                     document.getElementById('auth-status').classList.add('text-red-600');
                     showMessageModal("ì˜¤ë¥˜", "Firebase ì„¤ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                     return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // ì»¤ìŠ¤í…€ í† í° ë˜ëŠ” ìµëª… ì¸ì¦
                if (initialAuthToken) {
                    const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    userId = userCredential.user.uid;
                }
                
                // ì¸ì¦ ìƒíƒœ ì—…ë°ì´íŠ¸
                document.getElementById('auth-status').textContent = `ì‚¬ìš©ì ID: ${userId.substring(0, 8)}... (ì¸ì¦ë¨)`;
                document.getElementById('auth-status').classList.add('text-green-600');
                
                // Firestore ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                startFirestoreListener();
                
            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜:", error);
                // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì¢€ ë” ëª…í™•í•˜ê²Œ í‘œì‹œ
                const errorMessage = error.code ? `${error.code}` : `ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜`;
                document.getElementById('auth-status').textContent = `ì¸ì¦ ì˜¤ë¥˜: ${errorMessage}`;
                document.getElementById('auth-status').classList.add('text-red-600');
                showMessageModal("ì˜¤ë¥˜", `Firebase ì—°ê²° ë˜ëŠ” ì¸ì¦ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${errorMessage}. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`);
            }
        };

        /**
         * Firestoreì—ì„œ ìºë¦­í„° ëª©ë¡ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
         */
        const startFirestoreListener = () => {
            // Firestore ì»¬ë ‰ì…˜ ê²½ë¡œ: /artifacts/{appId}/public/data/characters
            const charCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'characters');
            
            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            onSnapshot(charCollectionRef, (snapshot) => {
                const fetchedCharacters = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const totalStats = calculateTotalStats(data.stats);
                    fetchedCharacters.push({
                        id: doc.id,
                        totalStats,
                        rank: determineRank(totalStats),
                        ...data
                    });
                });
                
                // ì´í•© ëŠ¥ë ¥ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (orderBy ë¯¸ì‚¬ìš©ì„ ìœ„í•´ JSì—ì„œ ì •ë ¬)
                characters = fetchedCharacters.sort((a, b) => b.totalStats - a.totalStats);
                
                // í˜„ì¬ ë·°ì— ë”°ë¼ í™”ë©´ì„ ë‹¤ì‹œ ë Œë”ë§
                renderApp();

            }, (error) => {
                console.error("Firestore ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
                showMessageModal("ë°ì´í„° ì˜¤ë¥˜", "ë­í‚¹ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        };

        // --- 4. ë Œë”ë§ í•¨ìˆ˜ ---

        /**
         * ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ ë·°ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        const renderApp = () => {
            renderFilterControls();
            
            switch (currentView) {
                case 'ranking':
                    renderRankingView();
                    break;
                case 'detail':
                    renderDetailView(selectedCharId);
                    break;
            }
            
            // ê´€ë¦¬ì íŒ¨ë„ í‘œì‹œ/ìˆ¨ê¸°ê¸°
            const adminPanel = document.getElementById('admin-panel');
            if (isAdmin) {
                adminPanel.classList.remove('hidden');
            } else {
                adminPanel.classList.add('hidden');
            }
        };

        /**
         * í•„í„° ì»¨íŠ¸ë¡¤ ë²„íŠ¼ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        const renderFilterControls = () => {
            const controls = document.getElementById('filter-controls');
            let html = '';

            // ì „ì²´ ë³´ê¸° ë²„íŠ¼
            html += `<button onclick="setFilter('all', null)" class="px-3 py-1 text-sm font-medium rounded-full transition duration-150 ${currentFilterType === 'all' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">ì „ì²´ ë³´ê¸°</button>`;

            // ë­í¬ í•„í„°
            html += `<div class="flex flex-wrap gap-2 p-2 bg-gray-100 rounded-lg">`;
            FILTERABLE_RANKS.forEach(rank => {
                html += `<button onclick="setFilter('rank', '${rank}')" class="px-3 py-1 text-sm font-medium rounded-full transition duration-150 ${currentFilterType === 'rank' && currentFilterValue === rank ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'}">ë­í¬ ${rank}</button>`;
            });
            html += `</div>`;

            // ì†Œì† í•„í„°
            html += `<div class="flex flex-wrap gap-2 p-2 bg-gray-100 rounded-lg">`;
            FILTERABLE_AFFILIATIONS.forEach(affiliation => {
                html += `<button onclick="setFilter('affiliation', '${affiliation}')" class="px-3 py-1 text-sm font-medium rounded-full transition duration-150 ${currentFilterType === 'affiliation' && currentFilterValue === affiliation ? 'bg-teal-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'}">${affiliation}</button>`;
            });
            html += `</div>`;
            
            // í¬ê·€ë„ í•„í„°
             html += `<div class="flex flex-wrap gap-2 p-2 bg-gray-100 rounded-lg">`;
            Object.keys(RARITY_STYLES).forEach(rarity => {
                const style = RARITY_STYLES[rarity];
                html += `<button onclick="setFilter('rarity', '${rarity}')" class="px-3 py-1 text-sm font-medium rounded-full transition duration-150 ${currentFilterType === 'rarity' && currentFilterValue === rarity ? 'bg-pink-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'}">${rarity}</button>`;
            });
            html += `</div>`;


            controls.innerHTML = html;

            let filterText = 'ì „ì²´ ë³´ê¸°';
            if (currentFilterType !== 'all') {
                filterText = `${currentFilterType === 'rank' ? 'ë­í¬' : currentFilterType === 'affiliation' ? 'ì†Œì†' : 'í¬ê·€ë„'}: ${currentFilterValue}`;
            }
            document.getElementById('current-filter-info').textContent = `í˜„ì¬ í•„í„°: ${filterText}`;
        };

        /**
         * ë­í‚¹ ë·°ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        const renderRankingView = () => {
            document.getElementById('ranking-view').classList.remove('hidden');
            document.getElementById('detail-view').classList.add('hidden');
            
            const rankingList = document.getElementById('ranking-list');
            
            // í•„í„°ë§ ì ìš©
            const filteredChars = characters.filter(char => {
                if (currentFilterType === 'all') return true;
                if (currentFilterType === 'rank') return char.rank === currentFilterValue;
                if (currentFilterType === 'affiliation') return char.affiliation === currentFilterValue;
                if (currentFilterType === 'rarity') return char.rarity === currentFilterValue;
                return true;
            });

            if (filteredChars.length === 0) {
                rankingList.innerHTML = `<p class="text-center text-gray-500 py-10">í˜„ì¬ í•„í„° ì¡°ê±´ì— ë§ëŠ” í—Œí„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }

            let html = filteredChars.map((char, index) => {
                // ë“±ìˆ˜ ê³„ì‚° (í•„í„°ë§ëœ ëª©ë¡ì—ì„œì˜ ìˆœìœ„)
                const overallRank = characters.findIndex(c => c.id === char.id) + 1;

                return `
                    <div onclick="showDetail('${char.id}')" class="flex items-center p-4 bg-gray-50 hover:bg-blue-50 transition duration-150 rounded-xl shadow-sm border border-gray-200 cursor-pointer">
                        <!-- ë“±ìˆ˜ -->
                        <div class="w-12 text-center text-xl font-extrabold ${overallRank <= 3 ? 'text-red-600' : 'text-gray-600'}">
                            ${overallRank}
                        </div>
                        <!-- ì •ë³´ -->
                        <div class="flex-grow ml-4">
                            <div class="flex items-center justify-between">
                                <span class="text-lg font-bold ${getRarityClass(char.rarity)}">${char.name}</span>
                                <span class="text-2xl font-black text-white px-3 py-1 rounded-lg ${char.rank === 'S' ? 'bg-red-600 shadow-lg' : char.rank === 'A' ? 'bg-yellow-600' : 'bg-gray-500'}">
                                    ${char.rank}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">
                                <span class="font-semibold">${char.affiliation}</span> | 
                                í¬ê·€ë„: <span class="font-bold ${getRarityClass(char.rarity)}">${char.rarity}</span> | 
                                ì´ ëŠ¥ë ¥ì¹˜: ${formatNumber(char.totalStats)}
                            </p>
                            ${renderResistanceTags(char.resistances)}
                        </div>
                    </div>
                `;
            }).join('');

            rankingList.innerHTML = html;
        };
        
        /**
         * ì €í•­ íƒœê·¸ HTML ë¬¸ìì—´ì„ ìƒì„±í•©ë‹ˆë‹¤.
         * @param {string[]} resistances - ì €í•­ ëª©ë¡
         * @returns {string} - HTML ë¬¸ìì—´
         */
        const renderResistanceTags = (resistances) => {
            if (!resistances || resistances.length === 0) return '';
            
            const tags = resistances.map(res => {
                let colorClass = 'bg-gray-200 text-gray-700';
                if (res === 'íƒœì–‘') colorClass = 'bg-yellow-100 text-yellow-800';
                else if (res === 'íŒŒë„') colorClass = 'bg-blue-100 text-blue-800';
                else if (res === 'í­í’') colorClass = 'bg-green-100 text-green-800';
                else if (res === 'ëŒ€ì§€') colorClass = 'bg-amber-100 text-amber-800';
                else if (res === 'ë°¤') colorClass = 'bg-indigo-100 text-indigo-800';

                return `<span class="resistance-tag ${colorClass}">${res}</span>`;
            }).join('');
            
            return `<div class="mt-2 flex flex-wrap">${tags}</div>`;
        };

        /**
         * ìºë¦­í„° ìƒì„¸ ë·°ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
         * @param {string} charId - ìºë¦­í„° ID
         */
        const renderDetailView = (charId) => {
            const char = characters.find(c => c.id === charId);
            if (!char) {
                showMessageModal("ì˜¤ë¥˜", "ìºë¦­í„° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                setView('ranking');
                return;
            }

            document.getElementById('ranking-view').classList.add('hidden');
            document.getElementById('detail-view').classList.remove('hidden');
            const detailView = document.getElementById('detail-view');
            
            const overallRank = characters.findIndex(c => c.id === char.id) + 1;
            
            let statHtml = STAT_NAMES.map((stat, index) => {
                const value = char.stats[stat] || 0;
                const maxStat = 1200; // ì„ì˜ì˜ ìµœëŒ€ê°’ ì„¤ì • (5000 / 5)
                const percentage = Math.min(100, (value / maxStat) * 100);

                return `
                    <div class="mb-3">
                        <div class="flex justify-between items-center text-sm font-medium text-gray-700">
                            <span>${stat}</span>
                            <span>${formatNumber(value)}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full stat-bar">
                            <div class="stat-bar stat-color-${index}" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            let resistanceHtml = char.resistances.map(res => {
                let colorClass = 'bg-gray-700';
                if (res === 'íƒœì–‘') colorClass = 'bg-yellow-600';
                else if (res === 'íŒŒë„') colorClass = 'bg-blue-600';
                else if (res === 'í­í’') colorClass = 'bg-green-600';
                else if (res === 'ëŒ€ì§€') colorClass = 'bg-amber-600';
                else if (res === 'ë°¤') colorClass = 'bg-indigo-600';

                return `<span class="px-3 py-1 rounded-full text-white font-semibold text-xs ${colorClass}">${res}</span>`;
            }).join('');


            detailView.innerHTML = `
                <button onclick="setView('ranking')" class="text-blue-500 hover:text-blue-700 flex items-center mb-4">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    ë­í‚¹ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>

                <div class="bg-white border p-6 rounded-xl shadow-lg">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <span class="text-sm font-semibold text-gray-500">No. ${overallRank}</span>
                            <h2 class="text-4xl font-extrabold ${getRarityClass(char.rarity)}">${char.name}</h2>
                            <p class="text-xl font-semibold text-gray-700 mt-1">${char.affiliation}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xl font-semibold text-gray-500">ë­í¬</span>
                            <span class="block text-5xl font-black text-white px-4 py-1 rounded-xl ${char.rank === 'S' ? 'bg-red-600 shadow-2xl' : char.rank === 'A' ? 'bg-yellow-600' : 'bg-gray-500'}">
                                ${char.rank}
                            </span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <!-- ê¸°ë³¸ ì •ë³´ ë° ì €í•­ -->
                        <div class="p-4 border rounded-lg bg-gray-50">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">ëŠ¥ë ¥ ìš”ì•½</h3>
                            <p><strong>ì´ ëŠ¥ë ¥ì¹˜:</strong> <span class="text-xl font-bold text-blue-600">${formatNumber(char.totalStats)}</span></p>
                            <p class="mt-2"><strong>í¬ê·€ë„:</strong> <span class="font-bold ${getRarityClass(char.rarity)}">${char.rarity}</span></p>
                            <div class="mt-4">
                                <p class="font-semibold mb-2">ì €í•­ íƒ€ì…:</p>
                                <div class="flex flex-wrap gap-2">${resistanceHtml}</div>
                            </div>
                        </div>

                        <!-- ëŠ¥ë ¥ì¹˜ ìƒì„¸ ë°” -->
                        <div class="p-4 border rounded-lg bg-gray-50">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">ëŠ¥ë ¥ì¹˜ ìƒì„¸</h3>
                            ${statHtml}
                        </div>
                    </div>

                    <!-- íˆ¬í‘œ ë²„íŠ¼ -->
                    <div class="mt-6 flex flex-col sm:flex-row gap-4 items-center">
                        <button onclick="handleVote('${char.id}', 'up')" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                            ì¶”ì²œ (${formatNumber(char.votes?.up || 0)})
                        </button>
                        <button onclick="handleVote('${char.id}', 'down')" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg transition duration-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            ë¹„ì¶”ì²œ (${formatNumber(char.votes?.down || 0)})
                        </button>
                    </div>

                    ${isAdmin ? `<div class="mt-6"><button onclick="showEditCharModal('${char.id}')" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">ìºë¦­í„° ìˆ˜ì • (ê´€ë¦¬ì)</button></div>` : ''}

                </div>
            `;
        };
        
        /**
         * íˆ¬í‘œ ì²˜ë¦¬ë¥¼ ìœ„í•œ íŠ¸ëœì­ì…˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
         * @param {string} charId - ìºë¦­í„° ID
         * @param {'up' | 'down'} type - íˆ¬í‘œ íƒ€ì…
         */
        window.handleVote = async (charId, type) => {
            if (!db || !userId) {
                showMessageModal("ì˜¤ë¥˜", "ì¸ì¦ ì •ë³´ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
                return;
            }

            const charRef = doc(db, 'artifacts', appId, 'public', 'data', 'characters', charId);
            const userVoteRef = doc(db, 'artifacts', appId, 'users', userId, 'votes', charId);
            const voteField = `votes.${type}`;
            const otherType = type === 'up' ? 'down' : 'up';
            const otherVoteField = `votes.${otherType}`;

            try {
                await runTransaction(db, async (transaction) => {
                    const charDoc = await transaction.get(charRef);
                    if (!charDoc.exists()) {
                        throw "ìºë¦­í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    }
                    const charData = charDoc.data();
                    
                    // ì‚¬ìš©ì íˆ¬í‘œ ê¸°ë¡ í™•ì¸
                    const userVoteDoc = await transaction.get(userVoteRef);
                    const hasVoted = userVoteDoc.exists();
                    const existingVote = hasVoted ? userVoteDoc.data().type : null;

                    let newVoteCount = charData.votes?.[type] || 0;
                    let newOtherVoteCount = charData.votes?.[otherType] || 0;
                    
                    let newVoteType = null;
                    
                    if (existingVote === type) {
                        // 1. ì´ë¯¸ ê°™ì€ ê³³ì— íˆ¬í‘œ: íˆ¬í‘œ ì·¨ì†Œ
                        newVoteCount = Math.max(0, newVoteCount - 1);
                        transaction.delete(userVoteRef);
                        newVoteType = null;
                        showMessageModal("íˆ¬í‘œ ì·¨ì†Œ", "íˆ¬í‘œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else if (existingVote === otherType) {
                        // 2. ë‹¤ë¥¸ ê³³ì— íˆ¬í‘œ: íˆ¬í‘œ ë³€ê²½ (ì´ì „ íˆ¬í‘œ ì·¨ì†Œ, ìƒˆ íˆ¬í‘œ ì¶”ê°€)
                        newOtherVoteCount = Math.max(0, newOtherVoteCount - 1); // ì´ì „ íˆ¬í‘œ ê°ì†Œ
                        newVoteCount += 1; // ìƒˆ íˆ¬í‘œ ì¦ê°€
                        transaction.set(userVoteRef, { type: type, timestamp: new Date().toISOString() });
                        newVoteType = type;
                        showMessageModal("íˆ¬í‘œ ë³€ê²½", "íˆ¬í‘œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else {
                        // 3. ì²« íˆ¬í‘œ: íˆ¬í‘œ ì¶”ê°€
                        newVoteCount += 1;
                        transaction.set(userVoteRef, { type: type, timestamp: new Date().toISOString() });
                        newVoteType = type;
                        showMessageModal("íˆ¬í‘œ ì„±ê³µ", "íˆ¬í‘œí•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!");
                    }

                    // Firestoreì— ëŠ¥ë ¥ì¹˜ ì—…ë°ì´íŠ¸ (TotalStatsëŠ” ì—¬ê¸°ì„œ ê³„ì‚°í•˜ì§€ ì•Šê³ , onSnapshotì—ì„œ ë°˜ì˜ë©ë‹ˆë‹¤.)
                    transaction.update(charRef, {
                        votes: {
                            up: type === 'up' ? newVoteCount : newOtherVoteCount,
                            down: type === 'down' ? newVoteCount : newOtherVoteCount,
                        }
                    });

                    // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (í•„ìˆ˜ ì•„ë‹˜, onSnapshotì´ ê²°êµ­ ë°˜ì˜í•  ê²ƒì„)
                    const charIndex = characters.findIndex(c => c.id === charId);
                    if (charIndex > -1) {
                        characters[charIndex].votes = {
                            up: type === 'up' ? newVoteCount : newOtherVoteCount,
                            down: type === 'down' ? newVoteCount : newOtherVoteCount,
                        };
                        renderDetailView(charId); // ìƒì„¸ ë·° ì—…ë°ì´íŠ¸
                    }
                });

            } catch (error) {
                console.error("íˆ¬í‘œ íŠ¸ëœì­ì…˜ ì˜¤ë¥˜:", error);
                showMessageModal("íˆ¬í‘œ ì‹¤íŒ¨", `íˆ¬í‘œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error}`);
            }
        };

        // --- 5. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë° ìƒíƒœ ê´€ë¦¬ ---
        
        /**
         * ë·°ë¥¼ ì „í™˜í•˜ê³  ë Œë”ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤.
         * @param {string} viewName - 'ranking' ë˜ëŠ” 'detail'
         */
        const setView = (viewName) => {
            currentView = viewName;
            renderApp();
        };

        /**
         * ìƒì„¸ ë·°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         * @param {string} charId - ìºë¦­í„° ID
         */
        window.showDetail = (charId) => {
            selectedCharId = charId;
            setView('detail');
        };

        /**
         * í•„í„°ë¥¼ ì„¤ì •í•˜ê³  ë­í‚¹ ë·°ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
         * @param {string} type - 'all', 'rank', 'affiliation', 'rarity'
         * @param {string | null} value - í•„í„° ê°’
         */
        window.setFilter = (type, value) => {
            currentFilterType = type;
            currentFilterValue = value;
            setView('ranking');
        };

        // --- 6. ê´€ë¦¬ì ê¸°ëŠ¥ (ëª¨ë‹¬ ë° ì¶”ê°€/ìˆ˜ì •) ---

        /**
         * ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        const showAdminLoginModal = () => {
             const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('hidden');
            modalContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full transform transition-all duration-300 scale-100">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”</h3>
                    <p class="text-gray-600 mb-4">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (íŒíŠ¸: ${MOCK_ADMIN_PASSWORD})</p>
                    <input type="password" id="admin-password-input" class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
                    <div class="flex gap-2">
                        <button id="admin-login-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg transition duration-200">
                            ë¡œê·¸ì¸
                        </button>
                        <button id="close-admin-modal-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded-lg transition duration-200">
                            ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            `;
            
            const closeBtn = document.getElementById('close-admin-modal-btn');
            const loginBtn = document.getElementById('admin-login-btn');
            const input = document.getElementById('admin-password-input');

            const closeModal = () => modalContainer.classList.add('hidden');

            closeBtn.onclick = closeModal;
            loginBtn.onclick = () => {
                if (input.value === MOCK_ADMIN_PASSWORD) {
                    isAdmin = true;
                    closeModal();
                    showMessageModal("ì„±ê³µ", "ê´€ë¦¬ì ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    renderApp(); // ê´€ë¦¬ì íŒ¨ë„ í‘œì‹œ
                } else {
                    showMessageModal("ì‹¤íŒ¨", "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    input.value = '';
                }
            };
        };

        /**
         * ìºë¦­í„° ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         * @param {string | null} charId - ìˆ˜ì • ì‹œ ìºë¦­í„° ID, ì¶”ê°€ ì‹œ null
         */
        const showEditCharModal = (charId = null) => {
            if (!isAdmin) {
                showMessageModal("ê¶Œí•œ ì—†ìŒ", "ê´€ë¦¬ìë§Œ ìºë¦­í„°ë¥¼ ì¶”ê°€/ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return;
            }
            
            const isEditing = !!charId;
            const char = isEditing ? characters.find(c => c.id === charId) : {};
            
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('hidden');

            let statInputs = STAT_NAMES.map((stat) => `
                <label class="block mb-2 text-sm font-medium text-gray-700">${stat}</label>
                <input type="number" id="stat-${stat}" value="${char.stats?.[stat] || ''}" min="0" class="w-full p-2 border border-gray-300 rounded-lg mb-3 focus:ring-blue-500 focus:border-blue-500" required>
            `).join('');

            let resistanceCheckboxes = ALL_RESISTANCES.map(res => `
                <label class="inline-flex items-center mr-4">
                    <input type="checkbox" id="res-${res}" value="${res}" ${char.resistances?.includes(res) ? 'checked' : ''} class="form-checkbox text-blue-600 rounded">
                    <span class="ml-2 text-sm text-gray-700">${res}</span>
                </label>
            `).join('');

            let rarityOptions = Object.keys(RARITY_STYLES).map(rarity => `
                <option value="${rarity}" ${char.rarity === rarity ? 'selected' : ''} class="${getRarityClass(rarity)}">${rarity}</option>
            `).join('');
            
            let affiliationOptions = ALLOWED_AFFILIATIONS.map(affil => `
                <option value="${affil}" ${char.affiliation === affil ? 'selected' : ''}>${affil}</option>
            `).join('');


            modalContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full transform transition-all duration-300 scale-100">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800">${isEditing ? 'ìºë¦­í„° ìˆ˜ì •' : 'ìƒˆ ìºë¦­í„° ì¶”ê°€'}</h3>
                    <form id="char-form">
                        <label class="block mb-2 text-sm font-medium text-gray-700">ì´ë¦„</label>
                        <input type="text" id="char-name" value="${char.name || ''}" class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500" required>
                        
                        <label class="block mb-2 text-sm font-medium text-gray-700">ì†Œì†</label>
                        <select id="char-affiliation" class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500" required>
                            ${affiliationOptions}
                        </select>
                        
                        <label class="block mb-2 text-sm font-medium text-gray-700">í¬ê·€ë„</label>
                        <select id="char-rarity" class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500" required>
                            ${rarityOptions}
                        </select>
                        
                        <h4 class="text-lg font-semibold mb-2 mt-4 text-gray-700">ëŠ¥ë ¥ì¹˜ (Stats)</h4>
                        <div class="grid grid-cols-2 gap-x-4">
                            ${statInputs}
                        </div>
                        
                        <h4 class="text-lg font-semibold mb-2 mt-4 text-gray-700">ì €í•­ (Resistances)</h4>
                        <div class="flex flex-wrap gap-2 mb-6 p-2 border rounded-lg">
                            ${resistanceCheckboxes}
                        </div>

                        <div class="flex gap-3">
                            <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-lg transition duration-200">
                                ${isEditing ? 'ìˆ˜ì • ì™„ë£Œ' : 'ìºë¦­í„° ì¶”ê°€'}
                            </button>
                            <button type="button" id="cancel-edit-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded-lg transition duration-200">
                                ì·¨ì†Œ
                            </button>
                            ${isEditing ? `<button type="button" id="delete-char-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg transition duration-200">ì‚­ì œ</button>` : ''}
                        </div>
                    </form>
                </div>
            `;
            
            document.getElementById('cancel-edit-btn').onclick = () => modalContainer.classList.add('hidden');
            if (isEditing) {
                document.getElementById('delete-char-btn').onclick = () => {
                    document.getElementById('modal-container').classList.add('hidden');
                    // ì»¤ìŠ¤í…€ ëª¨ë‹¬ë¡œ ëŒ€ì²´
                    showConfirmModal(`ì •ë§ë¡œ ${char.name} ìºë¦­í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => deleteCharacter(charId));
                };
            }

            document.getElementById('char-form').onsubmit = (e) => {
                e.preventDefault();
                saveCharacter(charId);
            };
        };
        
        /**
         * ì‚¬ìš©ì ì§€ì • í™•ì¸ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         * @param {string} message - í‘œì‹œí•  ë©”ì‹œì§€
         * @param {Function} onConfirm - í™•ì¸ ì‹œ ì‹¤í–‰í•  í•¨ìˆ˜
         */
        const showConfirmModal = (message, onConfirm) => {
             const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('hidden');
            modalContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full transform transition-all duration-300 scale-100">
                    <h3 class="text-xl font-bold mb-3 text-red-600">í™•ì¸ í•„ìš”</h3>
                    <p class="text-gray-600 mb-4">${message}</p>
                    <div class="flex gap-2">
                        <button id="confirm-yes-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg transition duration-200">
                            ì˜ˆ, ì‚­ì œí•©ë‹ˆë‹¤
                        </button>
                        <button id="confirm-no-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded-lg transition duration-200">
                            ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            `;
            
            const closeModal = () => modalContainer.classList.add('hidden');
            
            document.getElementById('confirm-yes-btn').onclick = () => {
                closeModal();
                onConfirm();
            };
            document.getElementById('confirm-no-btn').onclick = closeModal;
        }

        /**
         * ìºë¦­í„° ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì—¬ Firestoreì— ì €ì¥(ì¶”ê°€/ìˆ˜ì •)í•©ë‹ˆë‹¤.
         * @param {string | null} charId - ìˆ˜ì • ì‹œ ìºë¦­í„° ID, ì¶”ê°€ ì‹œ null
         */
        const saveCharacter = async (charId) => {
            const isEditing = !!charId;
            const charName = document.getElementById('char-name').value;
            const charAffiliation = document.getElementById('char-affiliation').value;
            const charRarity = document.getElementById('char-rarity').value;
            
            const stats = {};
            STAT_NAMES.forEach(stat => {
                stats[stat] = parseInt(document.getElementById(`stat-${stat}`).value) || 0;
            });

            const resistances = ALL_RESISTANCES.filter(res => document.getElementById(`res-${res}`).checked);
            
            const newCharData = {
                name: charName,
                affiliation: charAffiliation,
                rarity: charRarity,
                stats: stats,
                resistances: resistances,
            };

            document.getElementById('modal-container').classList.add('hidden');

            try {
                const charCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'characters');
                
                if (isEditing) {
                    // ìˆ˜ì •
                    const charRef = doc(charCollectionRef, charId);
                    await updateDoc(charRef, newCharData);
                    showMessageModal("ì„±ê³µ", `${charName} ìºë¦­í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } else {
                    // ì¶”ê°€
                    // votes í•„ë“œë¥¼ ì´ˆê¸°í™” (ì—†ìœ¼ë©´ íˆ¬í‘œ ì‹œ ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥)
                    newCharData.votes = { up: 0, down: 0 };
                    await setDoc(doc(charCollectionRef), newCharData); // addDoc ëŒ€ì‹  setDoc(docRef) ì‚¬ìš©
                    showMessageModal("ì„±ê³µ", `${charName} ìºë¦­í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            } catch (error) {
                console.error("ìºë¦­í„° ì €ì¥ ì˜¤ë¥˜:", error);
                showMessageModal("ì €ì¥ ì‹¤íŒ¨", "ìºë¦­í„° ì •ë³´ë¥¼ Firestoreì— ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        };

        /**
         * ìºë¦­í„°ë¥¼ Firestoreì—ì„œ ì‚­ì œí•©ë‹ˆë‹¤.
         * @param {string} charId - ìºë¦­í„° ID
         */
        const deleteCharacter = async (charId) => {
            const char = characters.find(c => c.id === charId);
            if (!char) return;

            try {
                const charRef = doc(db, 'artifacts', appId, 'public', 'data', 'characters', charId);
                await deleteDoc(charRef);
                showMessageModal("ì‚­ì œ ì„±ê³µ", `${char.name} ìºë¦­í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                setView('ranking'); // ë­í‚¹ ë·°ë¡œ ëŒì•„ê°€ê¸°
            } catch (error) {
                console.error("ìºë¦­í„° ì‚­ì œ ì˜¤ë¥˜:", error);
                showMessageModal("ì‚­ì œ ì‹¤íŒ¨", "ìºë¦­í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        };

        // --- 7. ì´ˆê¸° ì„¤ì • ---

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.addEventListener('DOMContentLoaded', () => {
            // ì´ˆê¸° Firebase ë° ì¸ì¦ ì‹œì‘
            initializeFirebase();
            
            // ê´€ë¦¬ì ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡ (ì˜ˆì‹œë¥¼ ìœ„í•´ ì„ì˜ì˜ ìš”ì†Œì— ì—°ê²°)
            document.getElementById('auth-status').classList.add('cursor-pointer', 'hover:text-blue-500');
            document.getElementById('auth-status').title = "í´ë¦­í•˜ì—¬ ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹œë„";
            document.getElementById('auth-status').onclick = showAdminLoginModal;
            
            // ìƒˆ ìºë¦­í„° ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('add-char-btn').onclick = () => showEditCharModal(null);
        });
    </script>
</body>
</html>


