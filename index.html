<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HUNTER ë­í‚¹ íŠ¸ë˜ì»¤</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&display=swap');
        
        :root {
            --main-purple: #794CFF;
            --main-purple-dark: #6333FF;
            --main-green: #BDF200;
            --main-bg: #000000;
            --card-bg: #1A1A1A; /* ê²€ì • ë°°ê²½ ëŒ€ë¹„ ì¹´ë“œ ìƒ‰ìƒ */
            --text-color: #F8F8F8;
            --text-secondary: #AAAAAA;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--main-bg);
            color: var(--text-color);
        }

        /* Tailwind Configuration for custom colors */
        .text-main-purple { color: var(--main-purple); }
        .bg-main-purple { background-color: var(--main-purple); }
        .hover\:bg-main-purple-dark:hover { background-color: var(--main-purple-dark); }
        .text-main-green { color: var(--main-green); }
        .bg-card { background-color: var(--card-bg); }
        .ring-main-purple:focus { --tw-ring-color: var(--main-purple); }
        .border-main-purple { border-color: var(--main-purple); }
        
        /* ê³ ì • í—¤ë” ì•„ë˜ì— ì½˜í…ì¸ ê°€ ê°€ë ¤ì§€ì§€ ì•Šë„ë¡ íŒ¨ë”© ì¶”ê°€ */
        #content-wrapper {
            padding-top: 4rem !important; 
        }

        /* XP ë°” ìŠ¤íƒ€ì¼ */
        .xp-bar {
            height: 8px;
            background-color: #333;
            border-radius: 9999px;
            overflow: hidden;
        }
        .xp-fill {
            background-color: var(--main-green);
            transition: width 0.5s ease-out;
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í„°ë§ˆì´ì§• (Dark Theme) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--main-purple);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background-color: #111;
        }

        .truncate-2-lines {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'main-purple': '#794CFF',
                        'main-purple-dark': '#6333FF',
                        'main-green': '#BDF200',
                        'main-bg': '#000000',
                        'card-bg': '#1A1A1A',
                    },
                }
            }
        }
    </script>
</head>
<body class="min-h-screen">
    
    <!-- JavaScript for Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ë¡œê·¸ ë ˆë²¨ ì„¤ì • (ë””ë²„ê¹… ìš©ì´)
        setLogLevel('debug');

        // =========================================================================
        // Canvas í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (Auth ì˜¤ë¥˜ ìˆ˜ì •)
        // =========================================================================
        // Canvasì—ì„œ ì œê³µí•˜ëŠ” ì „ì—­ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ Firebaseë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
        const firebaseConfig = (typeof __firebase_config !== 'undefined') 
            ? JSON.parse(__firebase_config) 
            : { /* GitHub Pages ë°°í¬ë¥¼ ìœ„í•´ ê¸°ì¡´ ì‚¬ìš©ì configë¥¼ ì—¬ê¸°ì— ë°±ì—…í•  ìˆ˜ ìˆìŒ */ }; 
            
        // Canvas ì•± ID ì‚¬ìš©
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-hunter-app';
        
        // ì´ˆê¸° ì¸ì¦ í† í° ë¡œë“œ
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // =========================================================================
        
        // ìƒìˆ˜ ì •ì˜
        const INITIAL_MOCK_DATA = [
            { id: 'h1', name: 'Shadow Hunter', rank: 'S', xp: 950, max_xp: 1000, level: 95, class: 'Assassin', description: 'ê·¸ë¦¼ìë¥¼ ì‚¬ëƒ¥í•˜ëŠ” ì „ì„¤ì ì¸ ì¡´ì¬.' },
            { id: 'h2', name: 'Flame Warrior', rank: 'A', xp: 820, max_xp: 1000, level: 82, class: 'Fighter', description: 'ë¶ˆê½ƒìœ¼ë¡œ ì ì„ ì œì••í•˜ëŠ” ê°•ë ¥í•œ ì „ì‚¬.' },
            { id: 'h3', name: 'Ice Mage', rank: 'B', xp: 510, max_xp: 1000, level: 51, class: 'Mage', description: 'ì°¨ê°€ìš´ ì–¼ìŒ ë§ˆë²•ìœ¼ë¡œ ê´‘ì—­ ê³µê²©ì„ ê°€í•˜ëŠ” ë§ˆë²•ì‚¬.' },
        ];
        const MOCK_ADMIN_PASSWORD = 'admin123'; // ì„ì‹œ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸
        
        let app;
        let db;
        let auth;
        let userId = 'loading';
        let isAdmin = false;

        // UI ìš”ì†Œ
        const rankingList = document.getElementById('ranking-list');
        const contentWrapper = document.getElementById('content-wrapper');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorAlert = document.getElementById('error-alert');
        const userIdDisplay = document.getElementById('user-id-display');
        const adminLink = document.getElementById('admin-link');
        const loginButton = document.getElementById('login-button');
        
        let characters = []; // ì „ì²´ ìºë¦­í„° ë°ì´í„°

        // =========================================================================
        // ì¸ì¦ ë° ì´ˆê¸°í™”
        // =========================================================================

        /**
         * Firebaseë¥¼ ì´ˆê¸°í™”í•˜ê³  ì‚¬ìš©ìë¥¼ ì¸ì¦í•©ë‹ˆë‹¤.
         */
        async function initAndAuthenticate() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Canvas í™˜ê²½ ë³€ìˆ˜ì— ë”°ë¼ ì¸ì¦ ì²˜ë¦¬: Custom Token ì‚¬ìš© ë˜ëŠ” ìµëª… ë¡œê·¸ì¸
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Authenticated using custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Authenticated anonymously.");
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `UID: ${userId}`;
                        console.log("Authentication successful. User ID:", userId);
                        
                        // ì¸ì¦ ì™„ë£Œ í›„ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                        listenForCharacters();
                    } else {
                        userId = 'anonymous'; 
                        userIdDisplay.textContent = 'ë¡œê·¸ì¸ í•„ìš”';
                        loadingIndicator.textContent = 'ì¸ì¦ ì˜¤ë¥˜ë¡œ ë°ì´í„° ë¡œë“œ ë¶ˆê°€';
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜:", error);
                errorAlert.textContent = `ğŸ”¥ Firebase ì—°ê²° ì˜¤ë¥˜: ${error.message}. ì½˜ì†” í™•ì¸ í•„ìš”.`;
                errorAlert.classList.remove('hidden');
                loadingIndicator.style.display = 'none';
            }
        }

        // =========================================================================
        // ë°ì´í„°ë² ì´ìŠ¤ ë° UI ì²˜ë¦¬
        // =========================================================================

        /**
         * Firestoreì—ì„œ ìºë¦­í„° ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì‹ í•©ë‹ˆë‹¤.
         */
        function listenForCharacters() {
            if (userId === 'loading' || userId === 'anonymous') {
                console.warn("Auth not ready or user is anonymous, deferring data listener.");
                return;
            }
            
            loadingIndicator.style.display = 'block';

            // Firestore ì»¬ë ‰ì…˜ ê²½ë¡œ: /artifacts/{appId}/public/data/hunters
            const huntersColRef = collection(db, `/artifacts/${appId}/public/data/hunters`);

            // onSnapshotì„ ì‚¬ìš©í•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™”
            onSnapshot(huntersColRef, (snapshot) => {
                loadingIndicator.style.display = 'none';
                errorAlert.classList.add('hidden');
                
                characters = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // ë­í‚¹ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (XP ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ)
                characters.sort((a, b) => (b.xp || 0) - (a.xp || 0));

                renderRankingList(characters);
                
                // ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° ëª©ì—… ë°ì´í„° ì‚½ì… ì‹œë„
                if (characters.length === 0) {
                    seedDatabase(huntersColRef);
                }

                // í˜„ì¬ í˜ì´ì§€ê°€ ìƒì„¸ í˜ì´ì§€ì¼ ê²½ìš°, ì—…ë°ì´íŠ¸ëœ ë‚´ìš©ìœ¼ë¡œ ë‹¤ì‹œ ë Œë”ë§
                if (contentWrapper.dataset.page === 'detail') {
                    const charId = contentWrapper.dataset.charId;
                    const updatedChar = characters.find(c => c.id === charId);
                    if (updatedChar) {
                        renderDetailPage(updatedChar);
                    } else {
                        navigateToRanking(); // ìºë¦­í„°ê°€ ì‚­ì œë˜ì—ˆìœ¼ë©´ ë­í‚¹ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    }
                }
            }, (error) => {
                console.error("Firestore ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
                // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ UIì— í‘œì‹œ
                errorAlert.textContent = `ë°ì´í„° ì‹¤ì‹œê°„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ. Firebase ê¶Œí•œ ë˜ëŠ” ê²½ë¡œ í™•ì¸ í•„ìš”. (${error.code || error.message})`;
                errorAlert.classList.remove('hidden');
                loadingIndicator.style.display = 'none';
            });
        }

        /**
         * ë°ì´í„°ë² ì´ìŠ¤ê°€ ë¹„ì–´ìˆì„ ê²½ìš° ëª©ì—… ë°ì´í„°ë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.
         */
        async function seedDatabase(colRef) {
            try {
                const existingDocs = await getDocs(colRef);
                if (existingDocs.empty) {
                    console.log("Database is empty. Attempting to seed mock data...");
                    for (const char of INITIAL_MOCK_DATA) {
                        // idë¥¼ ë¬¸ì„œ IDë¡œ ì§ì ‘ ì§€ì •í•˜ì—¬ setDoc ì‚¬ìš©
                        await setDoc(doc(colRef, char.id), char); 
                    }
                    console.log("Mock data seeded successfully.");
                    // ì„±ê³µì ìœ¼ë¡œ ì‹œë“œ í›„ onSnapshotì´ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨.
                }
            } catch (error) {
                console.error("Mock data seeding failed:", error);
                alertModal(`ğŸš¨ ì´ˆê¸° ë°ì´í„° ì„¤ì • ì‹¤íŒ¨: ${error.message}`, "danger"); // UI alert for seeding failure
            }
        }

        /**
         * ë­í‚¹ ëª©ë¡ HTMLì„ ìƒì„±í•˜ê³  ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderRankingList(data) {
            if (!rankingList) return; // ë­í‚¹ í˜ì´ì§€ê°€ ì•„ë‹ ê²½ìš° ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
            
            if (data.length === 0) {
                rankingList.innerHTML = `<li class="p-6 text-center text-gray-500">
                    í˜„ì¬ ë“±ë¡ëœ í—Œí„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì ë¡œê·¸ì¸ í›„ ë°ì´í„°ë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”. (ìë™ ì´ˆê¸°í™” ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)
                </li>`;
                return;
            }

            rankingList.innerHTML = data.map((char, index) => {
                const rankNumber = index + 1;
                const xpPercentage = char.max_xp ? ((char.xp / char.max_xp) * 100).toFixed(1) : 0;
                
                return `
                    <li class="bg-card p-4 rounded-xl shadow-lg transition duration-300 transform hover:bg-[#2A2A2A] cursor-pointer" 
                        onclick="navigateToDetail('${char.id}')">
                        <div class="flex items-center space-x-4">
                            <!-- ë­í¬ ë„˜ë²„ -->
                            <div class="text-3xl font-extrabold text-main-green w-10 text-center">${rankNumber}</div>
                            
                            <!-- ì •ë³´ ì»¨í…Œì´ë„ˆ -->
                            <div class="flex-grow">
                                <h3 class="text-xl font-bold text-main-purple">${char.name} <span class="text-sm font-normal text-gray-400">(${char.class})</span></h3>
                                <p class="text-sm text-gray-500 truncate-2-lines">${char.description}</p>
                                
                                <!-- XP ë°” -->
                                <div class="mt-2 flex items-center space-x-2">
                                    <div class="xp-bar flex-grow">
                                        <div class="xp-fill" style="width: ${xpPercentage}%;"></div>
                                    </div>
                                    <span class="text-xs text-main-green font-semibold">${char.xp} / ${char.max_xp} XP</span>
                                    <span class="text-xs text-gray-400">Lv.${char.level}</span>
                                </div>
                            </div>
                            
                            <!-- ë­í¬ ë“±ê¸‰ -->
                            <div class="flex-shrink-0 text-3xl font-black w-12 text-center" style="color: ${getRankColor(char.rank)};">
                                ${char.rank}
                            </div>
                        </div>
                    </li>
                `;
            }).join('');
        }

        /**
         * ìºë¦­í„° ìƒì„¸ í˜ì´ì§€ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderDetailPage(char) {
            contentWrapper.dataset.page = 'detail';
            contentWrapper.dataset.charId = char.id;
            const xpPercentage = char.max_xp ? ((char.xp / char.max_xp) * 100).toFixed(1) : 0;
            const rankColor = getRankColor(char.rank);

            contentWrapper.innerHTML = `
                <div class="max-w-4xl mx-auto p-4 sm:p-6 bg-card rounded-2xl shadow-2xl border border-main-purple/50">
                    <button onclick="navigateToRanking()" class="text-sm text-gray-400 hover:text-main-purple mb-4 flex items-center transition duration-200">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        ë­í‚¹ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                    
                    <div class="flex flex-col md:flex-row gap-6 items-start">
                        <!-- ì¢Œì¸¡ ì •ë³´ -->
                        <div class="md:w-1/3 w-full">
                            <div class="bg-main-purple/20 p-6 rounded-xl text-center">
                                <h2 class="text-4xl font-extrabold mb-1" style="color: ${rankColor};">${char.rank}</h2>
                                <p class="text-xs text-gray-400">CURRENT RANK</p>
                            </div>
                            <div class="mt-4 p-4 bg-card-bg rounded-xl border border-gray-700">
                                <p class="text-sm font-semibold text-gray-400">í´ë˜ìŠ¤:</p>
                                <p class="text-xl font-bold text-main-green">${char.class}</p>
                                <div class="mt-3 pt-3 border-t border-gray-800">
                                    <p class="text-sm font-semibold text-gray-400">ë ˆë²¨:</p>
                                    <p class="text-xl font-bold">${char.level}</p>
                                </div>
                            </div>
                        </div>

                        <!-- ìš°ì¸¡ ìƒì„¸ ì •ë³´ -->
                        <div class="md:w-2/3 w-full">
                            <h1 class="text-4xl sm:text-5xl font-black text-main-purple leading-tight">${char.name}</h1>
                            <p class="text-base text-gray-400 mt-2">${char.description}</p>
                            
                            <!-- XP ë°” ìƒì„¸ -->
                            <div class="mt-6 p-4 bg-main-bg rounded-xl border border-gray-800">
                                <div class="flex justify-between items-end mb-1">
                                    <span class="text-sm font-semibold text-main-green">ê²½í—˜ì¹˜ (XP)</span>
                                    <span class="text-lg font-bold">${char.xp} / ${char.max_xp}</span>
                                </div>
                                <div class="xp-bar h-3">
                                    <div class="xp-fill h-full" style="width: ${xpPercentage}%;"></div>
                                </div>
                                <p class="text-right text-xs text-gray-500 mt-1">${xpPercentage}% ì™„ë£Œ</p>
                            </div>

                            <!-- ê´€ë¦¬ì ìˆ˜ì • ë²„íŠ¼ -->
                            ${isAdmin ? `
                                <div class="mt-8">
                                    <button onclick="navigateToAdminPage('${char.id}')" 
                                        class="w-full sm:w-auto px-6 py-3 bg-main-green text-main-bg font-bold rounded-xl shadow-lg transition duration-300 hover:bg-opacity-80 transform hover:scale-[1.01]">
                                        ìºë¦­í„° ìˆ˜ì • (Admin)
                                    </button>
                                </div>
                            ` : ''}
                            
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * ê´€ë¦¬ì í˜ì´ì§€ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. (ìºë¦­í„° ë“±ë¡/ìˆ˜ì •/ì‚­ì œ)
         * @param {string | null} charId ìˆ˜ì •í•  ìºë¦­í„° ID (ë“±ë¡ ì‹œ null)
         */
        function renderAdminPage(charId = null) {
            if (!isAdmin) {
                alertModal("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.", "danger");
                navigateToRanking();
                return;
            }

            contentWrapper.dataset.page = 'admin';
            contentWrapper.dataset.charId = charId || '';

            const isEdit = charId !== null;
            const charToEdit = isEdit ? characters.find(c => c.id === charId) : {};

            const pageTitle = isEdit ? `í—Œí„° [${charToEdit.name}] ìˆ˜ì •` : 'ìƒˆë¡œìš´ í—Œí„° ë“±ë¡';
            const buttonText = isEdit ? 'ìˆ˜ì • ì‚¬í•­ ì €ì¥' : 'ìºë¦­í„° ë“±ë¡';
            const buttonBg = isEdit ? 'bg-main-green' : 'bg-main-purple';
            const deleteButton = isEdit ? `
                <button onclick="confirmDeleteCharacter('${charId}', '${charToEdit.name}')" 
                    class="w-full sm:w-auto px-6 py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg transition duration-300 hover:bg-red-700 transform hover:scale-[1.01]">
                    ìºë¦­í„° ì‚­ì œ
                </button>
            ` : '';

            contentWrapper.innerHTML = `
                <div class="max-w-3xl mx-auto p-4 sm:p-6 bg-card rounded-2xl shadow-2xl border border-main-green/50">
                    <h1 class="text-3xl font-black text-main-green mb-6">${pageTitle}</h1>
                    
                    <form id="admin-form" class="space-y-4">
                        <input type="hidden" name="id" value="${charId || ''}">

                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-300">ì´ë¦„</label>
                            <input type="text" id="name" name="name" required
                                class="mt-1 w-full p-3 bg-main-bg border border-gray-700 rounded-lg text-text-color focus:ring-main-purple focus:border-main-purple"
                                value="${charToEdit.name || ''}">
                        </div>

                        <div>
                            <label for="rank" class="block text-sm font-medium text-gray-300">ë­í¬ (S, A, B ë“±)</label>
                            <input type="text" id="rank" name="rank" required maxlength="5"
                                class="mt-1 w-full p-3 bg-main-bg border border-gray-700 rounded-lg text-text-color focus:ring-main-purple focus:border-main-purple"
                                value="${charToEdit.rank || ''}">
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="xp" class="block text-sm font-medium text-gray-300">í˜„ì¬ XP</label>
                                <input type="number" id="xp" name="xp" required
                                    class="mt-1 w-full p-3 bg-main-bg border border-gray-700 rounded-lg text-text-color focus:ring-main-purple focus:border-main-purple"
                                    value="${charToEdit.xp || 0}">
                            </div>
                            <div>
                                <label for="max_xp" class="block text-sm font-medium text-gray-300">ìµœëŒ€ XP (ë ˆë²¨ì—… ê¸°ì¤€)</label>
                                <input type="number" id="max_xp" name="max_xp" required
                                    class="mt-1 w-full p-3 bg-main-bg border border-gray-700 rounded-lg text-text-color focus:ring-main-purple focus:border-main-purple"
                                    value="${charToEdit.max_xp || 1000}">
                            </div>
                        </div>

                        <div>
                            <label for="level" class="block text-sm font-medium text-gray-300">ë ˆë²¨</label>
                            <input type="number" id="level" name="level" required
                                class="mt-1 w-full p-3 bg-main-bg border border-gray-700 rounded-lg text-text-color focus:ring-main-purple focus:border-main-purple"
                                value="${charToEdit.level || 1}">
                        </div>

                        <div>
                            <label for="class" class="block text-sm font-medium text-gray-300">í´ë˜ìŠ¤</label>
                            <input type="text" id="class" name="class" required
                                class="mt-1 w-full p-3 bg-main-bg border border-gray-700 rounded-lg text-text-color focus:ring-main-purple focus:border-main-purple"
                                value="${charToEdit.class || ''}">
                        </div>

                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-300">ì„¤ëª…</label>
                            <textarea id="description" name="description" rows="3" required
                                class="mt-1 w-full p-3 bg-main-bg border border-gray-700 rounded-lg text-text-color focus:ring-main-purple focus:border-main-purple resize-none">${charToEdit.description || ''}</textarea>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 pt-4">
                            <button type="submit" 
                                class="w-full sm:w-auto px-6 py-3 ${buttonBg} text-main-bg font-bold rounded-xl shadow-lg transition duration-300 hover:opacity-80 transform hover:scale-[1.01]">
                                ${buttonText}
                            </button>
                            ${deleteButton}
                            <button type="button" onclick="navigateToRanking()" 
                                class="w-full sm:w-auto px-6 py-3 border border-gray-600 text-gray-300 font-bold rounded-xl shadow-lg transition duration-300 hover:bg-gray-800 transform hover:scale-[1.01]">
                                ì·¨ì†Œ
                            </button>
                        </div>
                        
                        <div id="form-message" class="mt-4 text-center hidden p-3 rounded-lg"></div>
                    </form>
                </div>
            `;

            // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            document.getElementById('admin-form').addEventListener('submit', handleAdminSubmit);
        }

        /**
         * í¼ ì œì¶œ ì²˜ë¦¬
         */
        async function handleAdminSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const messageDiv = document.getElementById('form-message');
            messageDiv.classList.add('hidden');

            const formData = new FormData(form);
            const data = {
                name: formData.get('name'),
                rank: formData.get('rank').toUpperCase().trim(),
                xp: parseInt(formData.get('xp')),
                max_xp: parseInt(formData.get('max_xp')),
                level: parseInt(formData.get('level')),
                class: formData.get('class'),
                description: formData.get('description'),
            };

            const charId = formData.get('id') || doc(collection(db, `/artifacts/${appId}/public/data/hunters`)).id;
            const charRef = doc(db, `/artifacts/${appId}/public/data/hunters`, charId);

            try {
                await setDoc(charRef, data, { merge: true });

                const action = formData.get('id') ? 'ìˆ˜ì •' : 'ë“±ë¡';
                messageDiv.textContent = `âœ… í—Œí„° '${data.name}'ì´(ê°€) ì„±ê³µì ìœ¼ë¡œ ${action}ë˜ì—ˆìŠµë‹ˆë‹¤. 2ì´ˆ í›„ ë­í‚¹ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.`;
                messageDiv.className = 'mt-4 text-center p-3 rounded-lg text-main-bg bg-main-green font-bold';
                messageDiv.classList.remove('hidden');

                setTimeout(navigateToRanking, 2000);

            } catch (error) {
                console.error("ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:", error);
                messageDiv.textContent = `âŒ ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                messageDiv.className = 'mt-4 text-center p-3 rounded-lg text-white bg-red-600 font-bold';
                messageDiv.classList.remove('hidden');
            }
        }
        
        /**
         * ìºë¦­í„° ì‚­ì œ í™•ì¸ ëª¨ë‹¬
         */
        function confirmDeleteCharacter(charId, charName) {
            const modal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');

            modalMessage.innerHTML = `ì •ë§ í—Œí„° **'${charName}'**ì„(ë¥¼) ì˜êµ¬íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            
            // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            modalConfirmBtn.onclick = null;
            modalConfirmBtn.onclick = () => {
                deleteCharacter(charId, charName);
                closeModal();
            };
            
            modal.classList.remove('hidden');
        }
        
        /**
         * ì‹¤ì œ ìºë¦­í„° ì‚­ì œ í•¨ìˆ˜
         */
        async function deleteCharacter(charId, charName) {
            try {
                const charRef = doc(db, `/artifacts/${appId}/public/data/hunters`, charId);
                await deleteDoc(charRef);
                alertModal(`âœ… í—Œí„° '${charName}'ì´(ê°€) ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, "success");
                setTimeout(navigateToRanking, 1000);
            } catch (error) {
                console.error("ìºë¦­í„° ì‚­ì œ ì˜¤ë¥˜:", error);
                alertModal(`âŒ ì‚­ì œ ì˜¤ë¥˜: ${error.message}`, "danger");
            }
        }
        
        /**
         * ë­í¬ë³„ ìƒ‰ìƒ ì§€ì •
         */
        function getRankColor(rank) {
            const r = rank.toUpperCase().trim();
            if (r === 'S' || r === 'SS' || r === 'SSS') return '#FBBF24'; // Gold/Yellow
            if (r === 'A') return '#3B82F6'; // Blue
            if (r === 'B') return '#10B981'; // Green
            if (r === 'C') return '#6366F1'; // Indigo (Main Purple)
            return '#9CA3AF'; // Gray (Default)
        }

        // =========================================================================
        // ë¼ìš°íŒ… ë° UI ë³€ê²½
        // =========================================================================

        /**
         * í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜: ë­í‚¹ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
         */
        function navigateToRanking() {
            contentWrapper.dataset.page = 'ranking';
            contentWrapper.dataset.charId = '';
            contentWrapper.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-black text-main-purple mb-6 border-b border-main-purple/50 pb-2">HUNTER ë­í‚¹ ëª©ë¡</h2>
                    <ul id="ranking-list" class="space-y-4">
                        <!-- ë°ì´í„°ëŠ” listenForCharacters()ë¥¼ í†µí•´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤ -->
                        <!-- ë°ì´í„° ë¡œë”© ì „ì— í‘œì‹œë  ì„ì‹œ ë©”ì‹œì§€ -->
                        ${characters.length === 0 ? `<li class="p-6 text-center text-gray-500">ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì´ê±°ë‚˜, ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤...</li>` : ''}
                    </ul>
                </div>
            `;
            // ë°ì´í„°ê°€ ë¡œë“œë˜ì–´ ìˆìœ¼ë©´ ë°”ë¡œ ë Œë”ë§ (ê¹œë¹¡ì„ ë°©ì§€)
            if (characters.length > 0) {
                const currentRankingList = document.getElementById('ranking-list');
                if (currentRankingList) {
                    renderRankingList(characters);
                }
            }
        }

        /**
         * í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜: ìºë¦­í„° ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
         */
        function navigateToDetail(charId) {
            const char = characters.find(c => c.id === charId);
            if (char) {
                renderDetailPage(char);
            } else {
                alertModal("í•´ë‹¹ ìºë¦­í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "warning");
                navigateToRanking();
            }
        }

        /**
         * í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜: ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™ (ë“±ë¡ ë˜ëŠ” ìˆ˜ì •)
         */
        function navigateToAdminPage(charId = null) {
            if (isAdmin) {
                renderAdminPage(charId);
            } else {
                alertModal("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.", "danger");
                showLoginModal();
            }
        }
        
        /**
         * ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
         */
        function showLoginModal() {
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('admin-password').value = '';
        }
        
        /**
         * ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
         */
        function handleAdminLogin() {
            const passwordInput = document.getElementById('admin-password');
            const password = passwordInput.value;
            const messageDiv = document.getElementById('login-message');
            messageDiv.classList.add('hidden');

            if (password === MOCK_ADMIN_PASSWORD) {
                isAdmin = true;
                adminLink.classList.remove('hidden');
                document.getElementById('login-modal').classList.add('hidden');
                loginButton.classList.add('hidden');
                
                alertModal("âœ… ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
                navigateToAdminPage(); // ë¡œê·¸ì¸ í›„ ë°”ë¡œ ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™
            } else {
                messageDiv.textContent = 'âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                messageDiv.className = 'mt-3 p-2 text-center text-red-100 bg-red-600 rounded-lg font-medium';
                messageDiv.classList.remove('hidden');
            }
        }

        /**
         * ì»¤ìŠ¤í…€ ì•Œë¦¼/ë©”ì‹œì§€ ëª¨ë‹¬ í‘œì‹œ
         */
        function alertModal(message, type = 'info') {
            const modal = document.getElementById('alert-modal');
            const modalContent = document.getElementById('alert-modal-content');
            
            let bgColor = 'bg-blue-600';
            let textColor = 'text-white';
            if (type === 'success') { bgColor = 'bg-main-green'; textColor = 'text-main-bg'; }
            else if (type === 'danger') bgColor = 'bg-red-600';
            else if (type === 'warning') bgColor = 'bg-yellow-600';

            modalContent.className = `p-6 rounded-xl shadow-2xl max-w-sm w-full transition duration-300 ${bgColor} ${textColor}`;
            modalContent.innerHTML = `
                <p class="font-semibold text-lg">${message}</p>
                <button onclick="closeModal('alert-modal')" class="mt-4 px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-bold transition duration-200 ${textColor}">í™•ì¸</button>
            `;
            modal.classList.remove('hidden');
        }

        /**
         * ëª¨ë“  ëª¨ë‹¬ ë‹«ê¸°
         */
        function closeModal(id) {
            document.getElementById(id || 'login-modal').classList.add('hidden');
            document.getElementById('confirmation-modal').classList.add('hidden');
            document.getElementById('alert-modal').classList.add('hidden');
        }


        // ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
        window.onload = () => {
            initAndAuthenticate();
            navigateToRanking(); // ì´ˆê¸° í™”ë©´ì€ ë­í‚¹ ëª©ë¡
        };
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (HTML onclick ì´ë²¤íŠ¸ì—ì„œ ì‚¬ìš©)
        window.navigateToRanking = navigateToRanking;
        window.navigateToDetail = navigateToDetail;
        window.navigateToAdminPage = navigateToAdminPage;
        window.handleAdminLogin = handleAdminLogin;
        window.closeModal = closeModal;
        window.confirmDeleteCharacter = confirmDeleteCharacter;
        window.deleteCharacter = deleteCharacter;
        window.alertModal = alertModal;

    </script>
    
    <!-- 1. í—¤ë” (ê³ ì • ë‚´ë¹„ê²Œì´ì…˜ ë°”) -->
    <header class="fixed top-0 left-0 w-full h-16 bg-[#1A1A1A] shadow-xl z-50 border-b border-gray-800">
        <div class="max-w-7xl mx-auto h-full px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            
            <!-- íƒ€ì´í‹€ / ë¡œê³  -->
            <div class="flex flex-col justify-center h-full pt-4"> 
                <a href="#ranking" onclick="navigateToRanking()" class="text-2xl font-extrabold tracking-wider text-main-purple hover:text-main-purple-dark transition duration-300">
                    HUNTER THE BEGINNG 5
                </a>
                <span id="user-id-display" class="text-[10px] text-gray-500 truncate mt-[-2px] block">
                    ë¡œë”© ì¤‘...
                </span>
            </div>
            
            <!-- ë©”ë‰´ ë° ë¡œê·¸ì¸ ë²„íŠ¼ -->
            <nav class="flex items-center space-x-4">
                <a id="admin-link" href="#" onclick="navigateToAdminPage()" class="hidden px-3 py-1 text-sm font-bold text-main-green border border-main-green rounded-lg hover:bg-main-green/10 transition duration-200">
                    ADMIN
                </a>
                <button id="login-button" onclick="showLoginModal()" class="px-3 py-1 text-sm font-bold text-gray-300 bg-gray-700 rounded-lg hover:bg-main-purple transition duration-200">
                    ë¡œê·¸ì¸
                </button>
            </nav>
        </div>
    </header>

    <!-- 2. ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
    <main id="content-wrapper" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" style="min-height: calc(100vh - 4rem);">
        <!-- í˜ì´ì§€ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤ -->
        <div id="loading-indicator" class="text-center mt-12 text-main-purple font-semibold text-lg">
            ë°ì´í„° ë¡œë”© ì¤‘...
        </div>
        <div id="error-alert" role="alert" class="hidden text-center mt-8 p-4 bg-red-800 text-white rounded-xl font-medium shadow-lg">
            ğŸ”¥ Firebase ì—°ê²° ì˜¤ë¥˜: ì½˜ì†” í™•ì¸ í•„ìš”.
        </div>
    </main>

    <!-- 3. í‘¸í„° -->
    <footer class="bg-[#1A1A1A] text-gray-500 py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-xs">
            <p>&copy; 2025 HUNTER TRACKER. All rights reserved.</p>
            <p class="mt-1">Powered by Firebase & Tailwind CSS</p>
        </div>
    </footer>

    <!-- 4. ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-[100] flex items-center justify-center p-4" onclick="closeModal('login-modal')">
        <div class="bg-card p-6 rounded-xl shadow-2xl max-w-xs w-full transition duration-300 border border-main-purple" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-main-purple mb-4">ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
            <p class="text-sm text-gray-400 mb-4">ê´€ë¦¬ì í˜ì´ì§€ì— ì ‘ê·¼í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="password" id="admin-password" placeholder="ë¹„ë°€ë²ˆí˜¸" 
                   class="w-full p-3 bg-main-bg border border-gray-700 rounded-lg text-text-color focus:ring-main-purple focus:border-main-purple mb-4">
            <button onclick="handleAdminLogin()" class="w-full px-4 py-2 bg-main-purple text-main-bg font-bold rounded-lg hover:bg-main-purple-dark transition duration-200">
                ë¡œê·¸ì¸
            </button>
            <div id="login-message" class="hidden"></div>
            <p class="text-xs text-gray-500 mt-3 text-center">íŒíŠ¸: admin123</p>
        </div>
    </div>
    
    <!-- 5. í™•ì¸ (Confirmation) ëª¨ë‹¬ (ì‚­ì œìš©) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-[100] flex items-center justify-center p-4" onclick="closeModal('confirmation-modal')">
        <div class="bg-card p-6 rounded-xl shadow-2xl max-w-sm w-full transition duration-300 border border-red-600" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-red-500 mb-4">ê²½ê³ : ì‚­ì œ í™•ì¸</h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('confirmation-modal')" class="px-4 py-2 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700 transition duration-200">
                    ì·¨ì†Œ
                </button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-200">
                    ì‚­ì œ
                </button>
            </div>
        </div>
    </div>
    
    <!-- 6. ì•Œë¦¼ (Alert) ëª¨ë‹¬ -->
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-[100] flex items-center justify-center p-4" onclick="closeModal('alert-modal')">
        <div id="alert-modal-content" class="p-6 rounded-xl shadow-2xl max-w-sm w-full transition duration-300">
            <!-- Content is inserted via JavaScript -->
        </div>
    </div>

</body>
</html>
